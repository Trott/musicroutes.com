<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Music Routes Test w/ Freebase API</title>

    <style>
      .collapsible::before {
        content: '-';
        color: #777;
        font-family: monospace;
      }
      .collapsible.collapsed::before {
        content: '+';
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
</head>
<body>
  <progress>Loading...</progress>
  <ol id="results">
  </ol>
<script>
(function () {
  var getContributedTo = function (data) {
    var ol;

    if (data instanceof Array) {
      ol = $('<ol>');
      ol.hide();
      $.each(data, function (i, result) {
        // Per http://wiki.freebase.com/wiki/Machine_ID, mids may contain digits, lowercase consonants, underscore.
        // We allow vowels too for code readability.
        // Must have '/m/' as prefix.
        if (/^\/m\/[0-9a-z_]+$/.test(result.mid)) {
          var name = result.name || 'Untitled';

          // TODO: list out contributors (already in the data) in addition to just the name of the track
          // TODO: link to contributors freebase pages too, I suppose
          var a = $('<a>', {href: 'http://freebase.com' + result.mid, text: name});
          var li = $('<li>');
          a.appendTo(li);
          li.appendTo(ol);
        }
      });
    }

    return ol;
  }

  var service_url = 'https://www.googleapis.com/freebase/v1/mqlread/';

  query = JSON.stringify([{
    "mid": null,
    "name": null,
    "type": "/music/artist",
    "track": [{
      "mid": null,
      "name": null,
      "contributions": [{
        "mid": null,
        "contributor": null,
        "role": []
      }]
    }]
  }]);
  var params = {
    'html_escape': false,
    'query': query
  };
  $.getJSON(service_url + '?callback=?', params, function(response) {
    // TODO: Is this even how mqlread reports errors?
    if (response.error) {
      $('<div>', {text:response.error.message}).appendTo(document.body);
    }
    if (response.result instanceof Array) {
      $.each(response.result, function(i, result) {
        var name = result.name || 'Whoops! Looks like Freebase does not have the English name for this artist.';
        var span = $('<span>', {text: name}).addClass('collapsible collapsed');
        var li = $('<li>').append(span);

        if (result.track) {
          var contributedTo = getContributedTo(result.track);
          if (contributedTo) {
            contributedTo.appendTo(li);
            span.on('click', function () {
              contributedTo.toggle();
              span.toggleClass('collapsed');
            });
            li.appendTo($('#results'));
          }
        }
      });
      $('progress').hide();
    }
  });
}());
</script>
</body>
</html>